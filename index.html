<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manager</title>
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #06b6d4;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-dark: #0f172a;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --shadow-color: rgba(15, 23, 42, 0.06);
            --shadow-color-strong: rgba(15, 23, 42, 0.15);
            
            --sidebar-width: 280px;
            --header-height: 64px;
            
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            --shadow-sm: 0 1px 2px 0 var(--shadow-color);
            --shadow-md: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, "Noto Sans", Helvetica, Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
        }

        .login-box h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1.875rem;
            font-weight: 700;
        }

        .quote-box {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
        }

        .quote-text {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.9375rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .quote-author {
            text-align: right;
            color: var(--text-muted);
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-group input {
            width: 100%;
            max-width: 300px;
            padding: 0.625rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s;
            font-family: var(--font-family);
        }

        .pin-input {
            max-width: 200px !important;
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            font-weight: 600;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            font-family: var(--font-family);
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary.full-width {
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-edit {
            background: var(--info-color);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }

        .btn-edit:hover {
            background: #0891b2;
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            margin-top: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .success-message {
            color: var(--success-color);
            text-align: center;
            margin-top: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .google-sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-size: 0.8125rem;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .sync-indicator.syncing {
            background: var(--warning-color);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .sync-indicator.error {
            background: var(--error-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: var(--border-color);
        }

        .quote-banner {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(29, 78, 216, 0.05));
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .quote-banner-text {
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.9375rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .quote-banner-author {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .tabs {
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            padding: 0 2rem;
            overflow-x: auto;
        }

        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .filter-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .add-expense-form {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .add-expense-form h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            max-width: 300px;
            padding: 0.625rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s;
            font-family: var(--font-family);
            background: white;
        }

        .form-group textarea {
            max-width: 600px;
        }

        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .summary-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .summary-card h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .summary-card .amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .expenses-table {
            width: 100%;
            border-collapse: collapse;
        }

        .expenses-table thead {
            background: var(--bg-tertiary);
        }

        .expenses-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .expenses-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .expenses-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        .daily-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
        }

        .day-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .day-card h3 {
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-tertiary);
            font-size: 0.8125rem;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-item span:first-child {
            color: var(--text-secondary);
        }

        .category-item span:last-child {
            color: var(--text-primary);
            font-weight: 600;
        }

        .total-row {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--primary-color);
        }

        .chart-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .settings-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .settings-section h3 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .item-tag {
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .item-tag button {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .item-tag button:hover {
            background: #dc2626;
        }

        .add-item-form {
            display: flex;
            gap: 0.75rem;
            max-width: 500px;
        }

        .add-item-form input {
            flex: 1;
            padding: 0.625rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .add-item-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .notification-badge {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .notification-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .notification-panel {
            position: fixed;
            right: 0;
            top: var(--header-height);
            width: 400px;
            max-width: 90vw;
            height: calc(100vh - var(--header-height));
            background: white;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .notification-panel.active {
            transform: translateX(0);
        }

        .notification-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .notification-list {
            padding: 1rem;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.unread {
            background: rgba(37, 99, 235, 0.05);
            border-left: 3px solid var(--primary-color);
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            line-height: 1.5;
        }

        .notification-time {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .backup-history {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
        }

        .backup-info {
            flex: 1;
        }

        .backup-date {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .backup-size {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        canvas {
            max-height: 400px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
            }

            .header-left h1 {
                font-size: 1.25rem;
            }

            .content {
                padding: 1rem;
            }

            .tabs {
                padding: 0 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .daily-grid {
                grid-template-columns: 1fr;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                max-width: 100%;
            }

            .add-item-form {
                max-width: 100%;
            }

            .notification-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üîí Expense Manager</h1>
            
            <div class="quote-box">
                <div class="quote-text" id="loginQuote"></div>
                <div class="quote-author" id="loginQuoteAuthor"></div>
            </div>

            <form id="loginForm">
                <div class="form-group" style="text-align: center;">
                    <label for="pin">Enter PIN</label>
                    <input type="password" id="pin" class="pin-input" placeholder="****" maxlength="4" pattern="[0-9]{4}" required>
                </div>
                <button type="submit" class="btn btn-primary full-width">Login</button>
                <div class="error-message" id="loginError"></div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-left">
                <h1>üí∞ Expense Manager</h1>
            </div>
            <div class="header-right">
                <div class="google-sync-status" id="syncStatus">
                    <span class="sync-indicator" id="syncIndicator"></span>
                    <span id="syncText">Not Connected</span>
                </div>
                <div class="notification-badge" onclick="toggleNotifications()">
                    <span class="notification-icon">üîî</span>
                    <span class="notification-count" id="notificationCount">0</span>
                </div>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export</button>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div class="quote-banner">
            <div class="quote-banner-text" id="bannerQuote"></div>
            <div class="quote-banner-author" id="bannerQuoteAuthor"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('detailed')">Detailed Expenses</button>
            <button class="tab" onclick="showTab('daily')">Daily Expenses</button>
            <button class="tab" onclick="showTab('monthly')">Monthly Details</button>
            <button class="tab" onclick="showTab('settings')">Settings</button>
        </div>

        <!-- Notification Panel -->
        <div class="notification-panel" id="notificationPanel">
            <div class="notification-header">
                <h3>Notifications & Reminders</h3>
                <button class="notification-close" onclick="toggleNotifications()">√ó</button>
            </div>
            <div class="notification-list" id="notificationList"></div>
        </div>

        <div class="content">
            <!-- Detailed Expenses Tab -->
            <div id="detailed" class="tab-content active">
                <div class="summary-cards">
                    <div class="summary-card">
                        <h4>Today's Expenses</h4>
                        <div class="amount" id="todayTotal">‚Çπ0</div>
                    </div>
                    <div class="summary-card">
                        <h4>This Month</h4>
                        <div class="amount" id="monthTotal">‚Çπ0</div>
                    </div>
                    <div class="summary-card">
                        <h4>This Year</h4>
                        <div class="amount" id="yearTotal">‚Çπ0</div>
                    </div>
                </div>

                <div class="add-expense-form">
                    <h2>Add New Expense</h2>
                    <form id="expenseForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="category" required></select>
                            </div>
                            <div class="form-group">
                                <label>Amount</label>
                                <input type="number" id="amount" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Payment Mode</label>
                                <select id="mode" required></select>
                            </div>
                        </div>
                        <div class="form-row" style="align-items: flex-end;">
                            <div class="form-group" style="flex: 1;">
                                <label>Notes</label>
                                <textarea id="notes" rows="3" style="max-width: 100%;"></textarea>
                            </div>
                            <div class="button-group" style="margin-left: 1rem;">
                                <button type="submit" class="btn btn-primary">Add Expense</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display:none;">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <table class="expenses-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Payment Mode</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Daily Expenses Tab -->
            <div id="daily" class="tab-content">
                <div class="filter-section">
                    <h3>üîç Filter & Search</h3>
                    <div class="filter-row">
                        <div class="form-group">
                            <label>Search</label>
                            <input type="text" id="searchInput" placeholder="Search by notes..." oninput="applyFilters()">
                        </div>
                        <div class="form-group">
                            <label>Date From</label>
                            <input type="date" id="dateFrom" onchange="applyFilters()">
                        </div>
                        <div class="form-group">
                            <label>Date To</label>
                            <input type="date" id="dateTo" onchange="applyFilters()">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="filterCategory" onchange="applyFilters()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Mode</label>
                            <select id="filterMode" onchange="applyFilters()">
                                <option value="">All Modes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                        </div>
                    </div>
                </div>

                <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">Daily Expenses Summary</h2>
                <div id="dailyExpenses" class="daily-grid"></div>
            </div>

            <!-- Monthly Details Tab -->
            <div id="monthly" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin: 0;">Monthly Summary</h2>
                    <div class="form-group" style="margin: 0;">
                        <select id="yearFilter" onchange="renderMonthlyExpenses()" style="max-width: 150px;">
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="expenses-table" id="monthlyTable">
                        <thead id="monthlyTableHead"></thead>
                        <tbody id="monthlyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="settings-section">
                    <h3>‚òÅÔ∏è Google Drive Backup</h3>
                    <div id="googleNotConnected">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Connect your Google Drive to enable automatic backups</p>
                        <button class="btn btn-primary" onclick="connectGoogleDrive()">üîó Connect Google Drive</button>
                    </div>
                    <div id="googleConnected" style="display: none;">
                        <p style="color: var(--success-color); margin-bottom: 1rem;">‚úÖ Connected as: <strong id="googleEmail"></strong></p>
                        <div class="button-group" style="margin-bottom: 1rem;">
                            <button class="btn btn-success" onclick="backupNow()">üíæ Backup Now</button>
                            <button class="btn btn-warning" onclick="restoreBackup()">üì• Restore Backup</button>
                            <button class="btn btn-secondary" onclick="disconnectGoogleDrive()">üîå Disconnect</button>
                        </div>
                        <div class="form-group">
                            <label>Auto-Backup Frequency</label>
                            <select id="autoBackupFrequency" onchange="saveBackupSettings()">
                                <option value="none">Manual Only</option>
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                            </select>
                        </div>
                        <div style="margin-top: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.5rem;">Last Backup: <span id="lastBackupTime">Never</span></p>
                        </div>
                        <div class="backup-history" id="backupHistory"></div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Categories</h3>
                    <div class="item-list" id="categoriesList"></div>
                    <div class="add-item-form">
                        <input type="text" id="newCategory" placeholder="Add new category">
                        <button class="btn btn-primary" onclick="addCategory()">Add</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Payment Modes</h3>
                    <div class="item-list" id="modesList"></div>
                    <div class="add-item-form">
                        <input type="text" id="newMode" placeholder="Add new payment mode">
                        <button class="btn btn-primary" onclick="addMode()">Add</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>PIN Management</h3>
                    <div class="form-group">
                        <label>Current PIN</label>
                        <input type="password" id="currentPin" placeholder="Enter current PIN" maxlength="4" pattern="[0-9]{4}" style="max-width: 200px;">
                    </div>
                    <div class="form-group">
                        <label>New PIN</label>
                        <input type="password" id="newPin" placeholder="Enter new 4-digit PIN" maxlength="4" pattern="[0-9]{4}" style="max-width: 200px;">
                    </div>
                    <button class="btn btn-primary" onclick="changePin()">Change PIN</button>
                </div>

                <div class="settings-section">
                    <h3>Reminders & Notifications</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="dailySummaryReminder" onchange="saveReminderSettings()">
                            Daily Summary (End of Day)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="weeklySummaryReminder" onchange="saveReminderSettings()">
                            Weekly Summary (Sunday Evening)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="monthlyTargetReminder" onchange="saveReminderSettings()">
                            Monthly Target Alert
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Data Management</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 100 Inspiring Quotes
        const quotes = [
            { text: "A penny saved is a penny earned.", author: "Benjamin Franklin" },
            { text: "Do not save what is left after spending, but spend what is left after saving.", author: "Warren Buffett" },
            { text: "It's not how much money you make, but how much money you keep.", author: "Robert Kiyosaki" },
            { text: "The habit of saving is itself an education; it fosters every virtue.", author: "T.T. Munger" },
            { text: "Money looks better in the bank than on your feet.", author: "Sophia Amoruso" },
            { text: "Save a little money each month and at the end of the year you'll be surprised at how little you have.", author: "Ernest Haskins" },
            { text: "The art is not in making money, but in keeping it.", author: "Proverb" },
            { text: "Beware of little expenses; a small leak will sink a great ship.", author: "Benjamin Franklin" },
            { text: "You must gain control over your money or the lack of it will forever control you.", author: "Dave Ramsey" },
            { text: "Money is only a tool. It will take you wherever you wish, but it will not replace you as the driver.", author: "Ayn Rand" }
        ];

        let expenses = [];
        let categories = ['Breakfast', 'Lunch', 'Dinner', 'Snacks', 'Groceries', 'Mobile Recharge', 'Travel', 'Rent', 'Electricity', 'Internet', 'Miscellaneous'];
        let paymentModes = ['Cash', 'Google Pay', 'Phone Pe', 'Paytm', 'Credit Card', 'Debit Card'];
        let editingId = null;
        let chart = null;
        let notifications = [];
        let googleAccessToken = null;
        let googleUserEmail = null;
        const DEFAULT_PIN = '1616';
        const GOOGLE_CLIENT_ID = '446123618904-smkr5kl5nj5ta755efa05oirhn13fcpl.apps.googleusercontent.com'; 
        const BACKUP_FOLDER_NAME = 'ExpenseManagerBackups';

        // Initialize Google API
        function initGoogleAPI() {
            gapi.load('client', () => {
                gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                }).then(() => {
                    checkGoogleConnection();
                });
            });
        }

        // Connect to Google Drive
        function connectGoogleDrive() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        googleAccessToken = response.access_token;
                        gapi.client.setToken({access_token: googleAccessToken});
                        getUserInfo();
                        updateGoogleUI(true);
                        addNotification('Google Drive Connected', 'Successfully connected to Google Drive', 'success');
                        saveGoogleToken();
                    }
                }
            });
            client.requestAccessToken();
        }

        // Get user info
        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${googleAccessToken}` }
                });
                const data = await response.json();
                googleUserEmail = data.email;
                document.getElementById('googleEmail').textContent = googleUserEmail;
            } catch (error) {
                console.error('Error getting user info:', error);
            }
        }

        // Disconnect Google Drive
        function disconnectGoogleDrive() {
            if (confirm('Disconnect from Google Drive? Your local data will remain safe.')) {
                googleAccessToken = null;
                googleUserEmail = null;
                localStorage.removeItem('googleToken');
                localStorage.removeItem('googleEmail');
                updateGoogleUI(false);
                addNotification('Google Drive Disconnected', 'Successfully disconnected from Google Drive', 'info');
            }
        }

        // Update UI based on connection status
        function updateGoogleUI(connected) {
            document.getElementById('googleNotConnected').style.display = connected ? 'none' : 'block';
            document.getElementById('googleConnected').style.display = connected ? 'block' : 'none';
            
            const syncIndicator = document.getElementById('syncIndicator');
            const syncText = document.getElementById('syncText');
            
            if (connected) {
                syncIndicator.classList.add('connected');
                syncIndicator.classList.remove('error');
                syncText.textContent = 'Connected';
            } else {
                syncIndicator.classList.remove('connected');
                syncText.textContent = 'Not Connected';
            }
        }

        // Save Google token
        function saveGoogleToken() {
            if (googleAccessToken) {
                localStorage.setItem('googleToken', googleAccessToken);
                localStorage.setItem('googleEmail', googleUserEmail || '');
            }
        }

        // Check Google connection
        function checkGoogleConnection() {
            const savedToken = localStorage.getItem('googleToken');
            const savedEmail = localStorage.getItem('googleEmail');
            
            if (savedToken) {
                googleAccessToken = savedToken;
                googleUserEmail = savedEmail;
                gapi.client.setToken({access_token: googleAccessToken});
                updateGoogleUI(true);
                if (googleUserEmail) {
                    document.getElementById('googleEmail').textContent = googleUserEmail;
                }
                loadBackupHistory();
            }
        }

        // Create backup folder
        async function getOrCreateBackupFolder() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${BACKUP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                const folderMetadata = {
                    name: BACKUP_FOLDER_NAME,
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folder = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id'
                });

                return folder.result.id;
            } catch (error) {
                console.error('Error creating folder:', error);
                addNotification('Backup Error', 'Failed to create backup folder', 'error');
                return null;
            }
        }

        // Backup now
        async function backupNow() {
            if (!googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            updateSyncStatus('syncing', 'Backing up...');

            try {
                const folderId = await getOrCreateBackupFolder();
                if (!folderId) return;

                const backupData = {
                    expenses: expenses,
                    categories: categories,
                    paymentModes: paymentModes,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const fileName = `expense_backup_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;

                const metadata = {
                    name: fileName,
                    mimeType: 'application/json',
                    parents: [folderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${googleAccessToken}` },
                    body: form
                });

                if (response.ok) {
                    localStorage.setItem('lastBackupTime', new Date().toISOString());
                    document.getElementById('lastBackupTime').textContent = new Date().toLocaleString();
                    updateSyncStatus('connected', 'Backup successful');
                    addNotification('Backup Complete', 'Data backed up to Google Drive successfully', 'success');
                    loadBackupHistory();
                    
                    setTimeout(() => {
                        updateSyncStatus('connected', 'Connected');
                    }, 3000);
                } else {
                    throw new Error('Backup failed');
                }
            } catch (error) {
                console.error('Backup error:', error);
                updateSyncStatus('error', 'Backup failed');
                addNotification('Backup Failed', 'Failed to backup data to Google Drive', 'error');
            }
        }

        // Restore backup
        async function restoreBackup() {
            if (!googleAccessToken) {
                alert('Please connect to Google Drive first');
                return;
            }

            try {
                const folderId = await getOrCreateBackupFolder();
                if (!folderId) return;

                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false`,
                    orderBy: 'createdTime desc',
                    fields: 'files(id, name, createdTime)'
                });

                if (response.result.files.length === 0) {
                    alert('No backups found');
                    return;
                }

                const backupList = response.result.files.map((file, index) => 
                    `${index + 1}. ${file.name} (${new Date(file.createdTime).toLocaleString()})`
                ).join('\n');

                const choice = prompt(`Select backup to restore (enter number):\n\n${backupList}`);
                const choiceIndex = parseInt(choice) - 1;

                if (choiceIndex >= 0 && choiceIndex < response.result.files.length) {
                    const fileId = response.result.files[choiceIndex].id;
                    
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    const backupData = JSON.parse(fileResponse.body);
                    
                    if (confirm('This will replace all current data. Continue?')) {
                        expenses = backupData.expenses || [];
                        categories = backupData.categories || categories;
                        paymentModes = backupData.paymentModes || paymentModes;
                        
                        saveData();
                        updateCategoryDropdown();
                        updateModeDropdown();
                        updateFilterDropdowns();
                        updateCategoriesList();
                        updateModesList();
                        renderExpenses();
                        updateSummary();
                        
                        addNotification('Restore Complete', 'Data restored from backup successfully', 'success');
                    }
                }
            } catch (error) {
                console.error('Restore error:', error);
                addNotification('Restore Failed', 'Failed to restore backup', 'error');
            }
        }

        // Load backup history
        async function loadBackupHistory() {
            if (!googleAccessToken) return;

            try {
                const folderId = await getOrCreateBackupFolder();
                if (!folderId) return;

                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false`,
                    orderBy: 'createdTime desc',
                    pageSize: 10,
                    fields: 'files(id, name, createdTime, size)'
                });

                const historyDiv = document.getElementById('backupHistory');
                if (response.result.files.length === 0) {
                    historyDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No backups yet</p>';
                    return;
                }

                historyDiv.innerHTML = `
                    <h4 style="margin-top: 1.5rem; margin-bottom: 0.75rem;">Recent Backups (Last 10)</h4>
                    ${response.result.files.map(file => `
                        <div class="backup-item">
                            <div class="backup-info">
                                <div class="backup-date">${new Date(file.createdTime).toLocaleString()}</div>
                                <div class="backup-size">${(file.size / 1024).toFixed(2)} KB</div>
                            </div>
                        </div>
                    `).join('')}
                `;

                const lastBackup = localStorage.getItem('lastBackupTime');
                if (lastBackup) {
                    document.getElementById('lastBackupTime').textContent = new Date(lastBackup).toLocaleString();
                }
            } catch (error) {
                console.error('Error loading backup history:', error);
            }
        }

        // Save backup settings
        function saveBackupSettings() {
            const frequency = document.getElementById('autoBackupFrequency').value;
            localStorage.setItem('autoBackupFrequency', frequency);
            addNotification('Settings Saved', `Auto-backup frequency set to: ${frequency}`, 'success');
        }

        // Check auto backup
        function checkAutoBackup() {
            if (!googleAccessToken) return;

            const frequency = localStorage.getItem('autoBackupFrequency') || 'weekly';
            if (frequency === 'none') return;

            const lastBackup = localStorage.getItem('lastBackupTime');
            if (!lastBackup) {
                backupNow();
                return;
            }

            const lastBackupDate = new Date(lastBackup);
            const now = new Date();
            const daysDiff = (now - lastBackupDate) / (1000 * 60 * 60 * 24);

            if ((frequency === 'daily' && daysDiff >= 1) || (frequency === 'weekly' && daysDiff >= 7)) {
                backupNow();
            }
        }

        // Update sync status
        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const syncText = document.getElementById('syncText');
            
            indicator.className = 'sync-indicator';
            if (status === 'syncing') {
                indicator.classList.add('syncing');
            } else if (status === 'error') {
                indicator.classList.add('error');
            }
            
            syncText.textContent = text;
        }

        // Get random quote
        function getRandomQuote() {
            return quotes[Math.floor(Math.random() * quotes.length)];
        }

        // Display quote
        function displayQuote(textId, authorId) {
            const quote = getRandomQuote();
            document.getElementById(textId).textContent = `"${quote.text}"`;
            document.getElementById(authorId).textContent = `‚Äî ${quote.author}`;
        }

        // PIN functions
        function initPin() {
            if (!localStorage.getItem('appPin')) {
                localStorage.setItem('appPin', DEFAULT_PIN);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const pin = document.getElementById('pin').value;
            const storedPin = localStorage.getItem('appPin');
            
            if (pin === storedPin) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                sessionStorage.setItem('isLoggedIn', 'true');
                document.getElementById('pin').value = '';
                document.getElementById('loginError').textContent = '';
                displayQuote('bannerQuote', 'bannerQuoteAuthor');
                checkReminders();
                checkAutoBackup();
            } else {
                document.getElementById('loginError').textContent = 'Incorrect PIN';
            }
        });

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('active');
            displayQuote('loginQuote', 'loginQuoteAuthor');
        }

        function changePin() {
            const currentPin = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newPin').value;
            const storedPin = localStorage.getItem('appPin');
            
            if (!currentPin || !newPin) {
                alert('Please fill in both fields');
                return;
            }
            
            if (currentPin !== storedPin) {
                alert('Current PIN is incorrect');
                return;
            }
            
            if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                alert('New PIN must be exactly 4 digits');
                return;
            }
            
            localStorage.setItem('appPin', newPin);
            document.getElementById('currentPin').value = '';
            document.getElementById('newPin').value = '';
            alert('PIN changed successfully!');
        }

        // Check login
        function checkLogin() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('active');
                displayQuote('bannerQuote', 'bannerQuoteAuthor');
            } else {
                displayQuote('loginQuote', 'loginQuoteAuthor');
            }
        }

        // Notifications
        function addNotification(title, message, type = 'info') {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                time: new Date().toLocaleString(),
                read: false
            };
            notifications.unshift(notification);
            saveNotifications();
            updateNotificationBadge();
            renderNotifications();
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                renderNotifications();
            }
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            document.getElementById('notificationCount').textContent = unreadCount;
            document.getElementById('notificationCount').style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        function renderNotifications() {
            const list = document.getElementById('notificationList');
            if (notifications.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No notifications yet</p>';
                return;
            }
            
            list.innerHTML = notifications.map(n => `
                <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markAsRead(${n.id})">
                    <div class="notification-title">${n.title}</div>
                    <div class="notification-message">${n.message}</div>
                    <div class="notification-time">${n.time}</div>
                </div>
            `).join('');
        }

        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                saveNotifications();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function saveNotifications() {
            localStorage.setItem('notifications', JSON.stringify(notifications));
        }

        function loadNotifications() {
            const saved = localStorage.getItem('notifications');
            if (saved) {
                notifications = JSON.parse(saved);
                updateNotificationBadge();
            }
        }

        // Reminder Settings
        function saveReminderSettings() {
            const settings = {
                dailySummary: document.getElementById('dailySummaryReminder').checked,
                weeklySummary: document.getElementById('weeklySummaryReminder').checked,
                monthlyTarget: document.getElementById('monthlyTargetReminder').checked
            };
            localStorage.setItem('reminderSettings', JSON.stringify(settings));
        }

        function loadReminderSettings() {
            const saved = localStorage.getItem('reminderSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('dailySummaryReminder').checked = settings.dailySummary || false;
                document.getElementById('weeklySummaryReminder').checked = settings.weeklySummary || false;
                document.getElementById('monthlyTargetReminder').checked = settings.monthlyTarget || false;
            }
        }

        function checkReminders() {
            const settings = JSON.parse(localStorage.getItem('reminderSettings') || '{}');
            const lastCheck = localStorage.getItem('lastReminderCheck');
            const today = new Date().toDateString();
            
            if (lastCheck !== today) {
                const todayExpenses = expenses.filter(e => e.date === new Date().toISOString().split('T')[0]);
                const todayTotal = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                if (settings.dailySummary && todayTotal > 0) {
                    addNotification(
                        'Daily Summary',
                        `You spent ‚Çπ${todayTotal.toFixed(2)} today across ${todayExpenses.length} transactions.`,
                        'info'
                    );
                }
                
                const dayOfWeek = new Date().getDay();
                if (settings.weeklySummary && dayOfWeek === 0) {
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - 7);
                    const weekExpenses = expenses.filter(e => new Date(e.date) >= weekStart);
                    const weekTotal = weekExpenses.reduce((sum, e) => sum + e.amount, 0);
                    
                    addNotification(
                        'Weekly Summary',
                        `This week you spent ‚Çπ${weekTotal.toFixed(2)} across ${weekExpenses.length} transactions.`,
                        'info'
                    );
                }
                
                if (settings.monthlyTarget) {
                    const thisMonth = new Date().toISOString().slice(0, 7);
                    const monthExpenses = expenses.filter(e => e.date.startsWith(thisMonth));
                    const monthTotal = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
                    
                    if (monthTotal > 20000) {
                        addNotification(
                            'Monthly Alert',
                            `You've spent ‚Çπ${monthTotal.toFixed(2)} this month. Consider reviewing your budget!`,
                            'warning'
                        );
                    }
                }
                
                localStorage.setItem('lastReminderCheck', today);
            }
        }

        // Filter functions
        function updateFilterDropdowns() {
            const catSelect = document.getElementById('filterCategory');
            const modeSelect = document.getElementById('filterMode');
            
            catSelect.innerHTML = '<option value="">All Categories</option>' + 
                categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            modeSelect.innerHTML = '<option value="">All Modes</option>' + 
                paymentModes.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function updateYearFilter() {
            const yearSelect = document.getElementById('yearFilter');
            const years = [...new Set(expenses.map(e => e.date.slice(0, 4)))].sort().reverse();
            
            if (years.length === 0) {
                years.push(new Date().getFullYear().toString());
            }
            
            const currentYear = new Date().getFullYear().toString();
            yearSelect.innerHTML = years.map(y => 
                `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
            ).join('');
        }

        function applyFilters() {
            renderExpenses();
            if (document.getElementById('daily').classList.contains('active')) {
                renderDailyExpenses();
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterMode').value = '';
            renderExpenses();
            if (document.getElementById('daily').classList.contains('active')) {
                renderDailyExpenses();
            }
        }

        function getFilteredExpenses() {
            let filtered = [...expenses];
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(e => 
                    (e.notes && e.notes.toLowerCase().includes(searchTerm)) ||
                    e.category.toLowerCase().includes(searchTerm)
                );
            }
            
            const dateFrom = document.getElementById('dateFrom').value;
            if (dateFrom) {
                filtered = filtered.filter(e => e.date >= dateFrom);
            }
            
            const dateTo = document.getElementById('dateTo').value;
            if (dateTo) {
                filtered = filtered.filter(e => e.date <= dateTo);
            }
            
            const category = document.getElementById('filterCategory').value;
            if (category) {
                filtered = filtered.filter(e => e.category === category);
            }
            
            const mode = document.getElementById('filterMode').value;
            if (mode) {
                filtered = filtered.filter(e => e.mode === mode);
            }
            
            return filtered;
        }

        // Excel export
        function exportToExcel() {
            if (expenses.length === 0) {
                alert('No expenses to export');
                return;
            }

            const workbook = XLSX.utils.book_new();
            
            const detailedData = expenses.map(e => ({
                Date: e.date,
                'Sub-category': e.category,
                Amount: e.amount,
                'Payment Mode': e.mode,
                Notes: e.notes || ''
            }));
            const detailedSheet = XLSX.utils.json_to_sheet(detailedData);
            XLSX.utils.book_append_sheet(workbook, detailedSheet, 'Detailed Expenses');

            const dailyGrouped = {};
            expenses.forEach(e => {
                if (!dailyGrouped[e.date]) dailyGrouped[e.date] = {};
                if (!dailyGrouped[e.date][e.category]) dailyGrouped[e.date][e.category] = 0;
                dailyGrouped[e.date][e.category] += e.amount;
            });

            const dailyData = [];
            Object.keys(dailyGrouped).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                Object.entries(dailyGrouped[date]).forEach(([category, amount]) => {
                    dailyData.push({ Date: date, Category: category, Amount: amount });
                });
            });
            const dailySheet = XLSX.utils.json_to_sheet(dailyData);
            XLSX.utils.book_append_sheet(workbook, dailySheet, 'Daily Expenses');

            const monthlyData = {};
            const categoryTotals = {};
            expenses.forEach(e => {
                const month = e.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = {};
                if (!monthlyData[month][e.category]) monthlyData[month][e.category] = 0;
                if (!categoryTotals[e.category]) categoryTotals[e.category] = 0;
                
                monthlyData[month][e.category] += e.amount;
                categoryTotals[e.category] += e.amount;
            });

            const months = Object.keys(monthlyData).sort();
            const allCategories = Object.keys(categoryTotals).sort();
            
            const monthlyExport = allCategories.map(cat => {
                const row = { Category: cat };
                months.forEach(m => { row[m] = monthlyData[m][cat] || 0; });
                row.Total = categoryTotals[cat];
                return row;
            });

            const monthlySheet = XLSX.utils.json_to_sheet(monthlyExport);
            XLSX.utils.book_append_sheet(workbook, monthlySheet, 'Monthly Details');

            const fileName = `Expense_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            addNotification('Export Successful', `Expense report exported as ${fileName}`, 'success');
        }

        // Load and save data
        function loadData() {
            const savedExpenses = localStorage.getItem('expenses');
            const savedCategories = localStorage.getItem('categories');
            const savedModes = localStorage.getItem('paymentModes');
            
            if (savedExpenses) expenses = JSON.parse(savedExpenses);
            if (savedCategories) categories = JSON.parse(savedCategories);
            if (savedModes) paymentModes = JSON.parse(savedModes);
        }

        function saveData() {
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('paymentModes', JSON.stringify(paymentModes));
        }

        function init() {
            initPin();
            checkLogin();
            loadData();
            loadNotifications();
            loadReminderSettings();
            updateCategoryDropdown();
            updateModeDropdown();
            updateFilterDropdowns();
            updateYearFilter();
            updateCategoriesList();
            updateModesList();
            renderExpenses();
            updateSummary();
            document.getElementById('date').valueAsDate = new Date();
            initGoogleAPI();
            
            const autoBackupFreq = localStorage.getItem('autoBackupFrequency');
            if (autoBackupFreq) {
                document.getElementById('autoBackupFrequency').value = autoBackupFreq;
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'daily') renderDailyExpenses();
            if (tabName === 'monthly') {
                updateYearFilter();
                renderMonthlyExpenses();
            }
            
            displayQuote('bannerQuote', 'bannerQuoteAuthor');
        }

        function updateCategoryDropdown() {
            const select = document.getElementById('category');
            select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateModeDropdown() {
            const select = document.getElementById('mode');
            select.innerHTML = paymentModes.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const expense = {
                id: editingId || Date.now(),
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                amount: parseFloat(document.getElementById('amount').value),
                mode: document.getElementById('mode').value,
                notes: document.getElementById('notes').value
            };

            if (editingId) {
                const index = expenses.findIndex(e => e.id === editingId);
                expenses[index] = expense;
                editingId = null;
                document.getElementById('cancelBtn').style.display = 'none';
                addNotification('Expense Updated', `Updated ${expense.category} expense of ‚Çπ${expense.amount}`, 'success');
            } else {
                expenses.push(expense);
                addNotification('Expense Added', `Added ${expense.category} expense of ‚Çπ${expense.amount}`, 'success');
            }

            saveData();
            renderExpenses();
            updateSummary();
            this.reset();
            document.getElementById('date').valueAsDate = new Date();
            checkReminders();
        });

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            document.getElementById('date').value = expense.date;
            document.getElementById('category').value = expense.category;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('mode').value = expense.mode;
            document.getElementById('notes').value = expense.notes;
            editingId = id;
            document.getElementById('cancelBtn').style.display = 'inline-block';
            window.scrollTo(0, 0);
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('expenseForm').reset();
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('date').valueAsDate = new Date();
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                const expense = expenses.find(e => e.id === id);
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                renderExpenses();
                updateSummary();
                addNotification('Expense Deleted', `Deleted ${expense.category} expense of ‚Çπ${expense.amount}`, 'info');
            }
        }

        function renderExpenses() {
            const tbody = document.getElementById('expensesBody');
            const filtered = getFilteredExpenses();
            const sortedExpenses = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedExpenses.map(e => `
                <tr>
                    <td>${new Date(e.date).toLocaleDateString()}</td>
                    <td>${e.category}</td>
                    <td>‚Çπ${e.amount.toFixed(2)}</td>
                    <td>${e.mode}</td>
                    <td>${e.notes || '-'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editExpense(${e.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteExpense(${e.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateSummary() {
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisYear = new Date().getFullYear();

            const todayTotal = expenses
                .filter(e => e.date === today)
                .reduce((sum, e) => sum + e.amount, 0);

            const monthTotal = expenses
                .filter(e => e.date.startsWith(thisMonth))
                .reduce((sum, e) => sum + e.amount, 0);

            const yearTotal = expenses
                .filter(e => e.date.startsWith(thisYear.toString()))
                .reduce((sum, e) => sum + e.amount, 0);

            document.getElementById('todayTotal').textContent = `‚Çπ${todayTotal.toFixed(2)}`;
            document.getElementById('monthTotal').textContent = `‚Çπ${monthTotal.toFixed(2)}`;
            document.getElementById('yearTotal').textContent = `‚Çπ${yearTotal.toFixed(2)}`;
        }

        function renderDailyExpenses() {
            const dailyDiv = document.getElementById('dailyExpenses');
            const grouped = {};

            const filtered = getFilteredExpenses();

            filtered.forEach(e => {
                if (!grouped[e.date]) grouped[e.date] = {};
                if (!grouped[e.date][e.category]) grouped[e.date][e.category] = 0;
                grouped[e.date][e.category] += e.amount;
            });

            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            if (sortedDates.length === 0) {
                dailyDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No expenses found</p>';
                return;
            }

            dailyDiv.innerHTML = sortedDates.map(date => {
                const dayTotal = Object.values(grouped[date]).reduce((sum, amt) => sum + amt, 0);
                return `
                    <div class="day-card">
                        <h3>${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                        ${Object.entries(grouped[date]).map(([cat, amt]) => `
                            <div class="category-item">
                                <span>${cat}</span>
                                <span>‚Çπ${amt.toFixed(2)}</span>
                            </div>
                        `).join('')}
                        <div class="category-item total-row">
                            <span>Total</span>
                            <span>‚Çπ${dayTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMonthlyExpenses() {
            const selectedYear = document.getElementById('yearFilter').value;
            const monthlyData = {};
            const categoryTotals = {};

            const yearExpenses = expenses.filter(e => e.date.startsWith(selectedYear));

            yearExpenses.forEach(e => {
                const month = e.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = {};
                if (!monthlyData[month][e.category]) monthlyData[month][e.category] = 0;
                if (!categoryTotals[e.category]) categoryTotals[e.category] = 0;
                
                monthlyData[month][e.category] += e.amount;
                categoryTotals[e.category] += e.amount;
            });

            const months = Object.keys(monthlyData).sort();
            const allCategories = Object.keys(categoryTotals).sort();

            const thead = document.getElementById('monthlyTableHead');
            const tbody = document.getElementById('monthlyTableBody');

            thead.innerHTML = `
                <tr>
                    <th>Category</th>
                    ${months.map(m => `<th>${new Date(m + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</th>`).join('')}
                    <th>Total</th>
                </tr>
            `;

            tbody.innerHTML = allCategories.map(cat => {
                const rowTotal = categoryTotals[cat];
                return `
                    <tr>
                        <td><strong>${cat}</strong></td>
                        ${months.map(m => `<td>‚Çπ${(monthlyData[m][cat] || 0).toFixed(0)}</td>`).join('')}
                        <td><strong>‚Çπ${rowTotal.toFixed(0)}</strong></td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: var(--bg-tertiary); font-weight: 600;">
                    <td>Total</td>
                    ${months.map(m => {
                        const monthTotal = Object.values(monthlyData[m]).reduce((sum, amt) => sum + amt, 0);
                        return `<td>‚Çπ${monthTotal.toFixed(0)}</td>`;
                    }).join('')}
                    <td>‚Çπ${Object.values(categoryTotals).reduce((sum, amt) => sum + amt, 0).toFixed(0)}</td>
                </tr>
            `;

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            if (chart) chart.destroy();

            const colors = [
                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#06b6d4',
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#6366f1',
                '#84cc16', '#f43f5e', '#0ea5e9', '#a855f7', '#22c55e'
            ];

            const datasets = allCategories.map((category, index) => {
                const color = colors[index % colors.length];
                return {
                    label: category,
                    data: months.map(m => monthlyData[m][category] || 0),
                    borderColor: color,
                    backgroundColor: color + '20',
                    tension: 0.4,
                    fill: false,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months.map(m => new Date(m + '-01').toLocaleDateString('en-US', { month: 'short' })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function updateCategoriesList() {
            const list = document.getElementById('categoriesList');
            list.innerHTML = categories.map(c => `
                <div class="item-tag">
                    ${c}
                    <button onclick="removeCategory('${c}')">√ó</button>
                </div>
            `).join('');
        }

        function addCategory() {
            const input = document.getElementById('newCategory');
            const value = input.value.trim();
            if (value && !categories.includes(value)) {
                categories.push(value);
                saveData();
                updateCategoryDropdown();
                updateFilterDropdowns();
                updateCategoriesList();
                input.value = '';
            }
        }

        function removeCategory(cat) {
            if (confirm(`Remove category "${cat}"?`)) {
                categories = categories.filter(c => c !== cat);
                saveData();
                updateCategoryDropdown();
                updateFilterDropdowns();
                updateCategoriesList();
            }
        }

        function updateModesList() {
            const list = document.getElementById('modesList');
            list.innerHTML = paymentModes.map(m => `
                <div class="item-tag">
                    ${m}
                    <button onclick="removeMode('${m}')">√ó</button>
                </div>
            `).join('');
        }

        function addMode() {
            const input = document.getElementById('newMode');
            const value = input.value.trim();
            if (value && !paymentModes.includes(value)) {
                paymentModes.push(value);
                saveData();
                updateModeDropdown();
                updateFilterDropdowns();
                updateModesList();
                input.value = '';
            }
        }

        function removeMode(mode) {
            if (confirm(`Remove payment mode "${mode}"?`)) {
                paymentModes = paymentModes.filter(m => m !== mode);
                saveData();
                updateModeDropdown();
                updateFilterDropdowns();
                updateModesList();
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                expenses = [];
                saveData();
                renderExpenses();
                updateSummary();
                addNotification('Data Cleared', 'All expense data has been cleared', 'info');
            }
        }

        init();
    </script>
</body>
</html>
